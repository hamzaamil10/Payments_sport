{% extends "league/base.html" %}
{% load static %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'league/css/match_detail.css' %}">
{% endblock %}

{% block content %}
<div class="match-shell">

  <div class="card">
    <div class="card-b">

      <div class="match-hero">
        <div>
          <h2>{{ match.title }}</h2>

          <div class="match-sub">
            <span class="kv">üìÖ {{ match.date }} ‚Ä¢ {{ match.time }}</span>
            <span class="kv">üìç {{ match.location }}</span>

            {% if match.final_score %}
              <span class="badge badge-lock">Finalized üîí</span>
            {% else %}
              <span class="badge badge-ok">Open ‚úÖ</span>
            {% endif %}
          </div>

          <div class="score-strip">
            {% for t in match.teams.all %}
              <span class="score-pill">
                {{ t.name }} <span class="score-num">{{ t.score }}</span>
              </span>
            {% empty %}
              <span class="muted">No teams created yet.</span>
            {% endfor %}
          </div>

          <div class="divider"></div>

          <div class="kv">üë• Capacity: <strong id="cap">{{ match.confirmed_count }}</strong> / {{ match.max_players }}</div>

          <div class="names">
            {% for p in participants %}
              {% if p.status == "going" %}
                <span class="chip">{{ p.player.nickname|default:p.player.user.username }}</span>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <!-- Actions (hidden if finalized) -->
        <div>
          {% if not match.final_score %}
            <div class="row" style="justify-content:flex-end;">
              <button class="btn btn-primary" id="btnJoin">Join</button>
              <button class="btn btn-danger" id="btnLeave">Leave</button>
            </div>

            <div class="row" style="justify-content:flex-end; margin-top:10px;">
              <select id="statusSelect" class="btn" style="padding:10px 12px">
                <option value="going">Going</option>
                <option value="maybe">Maybe</option>
                <option value="not_going">Not Going</option>
              </select>
              <button class="btn" id="btnSetStatus">Update</button>
            </div>
          {% else %}
            <div class="kv">üîí Read-only match</div>
          {% endif %}
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0;">Participants</h3>
      <div class="table-wrap">
        <table class="table" id="participantsTable">
          <thead>
            <tr>
              <th>Player</th>
              <th>Status</th>
              <th>Team</th>
              <th class="t-left">Goals</th>
              <th class="t-left">Assists</th>
              <th class="t-center">MVP</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

  <div class="card">
    <div class="card-b">
      <h3 style="margin:0;">Info</h3>
      <div class="info-line">{{ match.notes|default:"‚Äî" }}</div>
      {% if match.created_by %}
        <div class="info-line">Organizer: <strong>{{ match.created_by }}</strong></div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  const MATCH_ID = {{ match.id }};
  const FINALIZED = {{ match.final_score|yesno:"true,false" }};
  const API_BASE = "/api/matches/" + MATCH_ID + "/";

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  async function apiPost(url, body=null){
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
      body: body ? JSON.stringify(body) : null
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || res.statusText);
    }
    return res.status === 204 ? null : await res.json();
  }

  async function loadParticipants(){
    const res = await fetch(API_BASE + "participants/");
    if(!res.ok) return;
    const data = await res.json();

    const tbody = document.querySelector("#participantsTable tbody");
    tbody.innerHTML = "";

    let confirmed = 0;

    data.forEach(p => {
      const status = p.status;
      if(status === "going") confirmed++;

      const playerName = p.player?.nickname || p.player?.username || p.player?.user || "‚Äî";
      const teamName = p.team?.name || "‚Äî";
      const mvp = p.is_mvp ? `<span class="mvp">üèÖ</span>` : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${playerName}</td>
        <td>${status}</td>
        <td>${teamName}</td>
        <td class="t-right">${p.goals}</td>
        <td class="t-right">${p.assists}</td>
        <td class="t-center">${mvp}</td>
      `;
      tbody.appendChild(tr);
    });

    const cap = document.getElementById("cap");
    if(cap) cap.textContent = confirmed;
  }

  async function join(){ await apiPost(API_BASE+"join/", {status:"going"}); loadParticipants(); }
  async function leave(){ await apiPost(API_BASE+"leave/"); loadParticipants(); }
  async function setStatus(){
    const s = document.getElementById("statusSelect").value;
    await apiPost(API_BASE+"join/", {status:s});
    loadParticipants();
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadParticipants();
    if(FINALIZED) return;

    document.getElementById("btnJoin")?.addEventListener("click", () => join());
    document.getElementById("btnLeave")?.addEventListener("click", () => leave());
    document.getElementById("btnSetStatus")?.addEventListener("click", () => setStatus());
  });
</script>
{% endblock %}
