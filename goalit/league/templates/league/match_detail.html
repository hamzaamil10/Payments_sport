{% extends "league/base.html" %}
{% load static %}
{% block page_css %}
<link rel="stylesheet" href="{% static 'league/css/match_detail.css' %}">
{% endblock %}

{% block content %}

<div class="grid">
  <div class="card">
    <div class="card-h">
      <div>
        <h2 style="margin:0">{{ match.title }}</h2>
        <div class="muted">{{ match.date }} {{ match.time }} ‚Ä¢ {{ match.location }}</div>
      </div>

      {% if match.final_score %}
        <span class="badge badge-lock">Finalized üîí</span>
      {% else %}
        <span class="badge badge-ok">Open ‚úÖ</span>
      {% endif %}
    </div>

    <div class="card-b">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="muted">Capacity: <span id="cap">{{ match.confirmed_count }}</span>/{{ match.max_players }}</div>

        {% if not match.final_score %}
        <div class="row">
          <button class="btn btn-primary" id="btnJoin">Join</button>
          <button class="btn btn-danger" id="btnLeave">Leave</button>

          <select id="statusSelect" class="btn" style="padding:10px 12px">
            <option value="going">Going</option>
            <option value="maybe">Maybe</option>
            <option value="not_going">Not Going</option>
          </select>
          <button class="btn" id="btnSetStatus">Update Status</button>
        </div>
        {% endif %}
      </div>

      <hr style="border:0; border-top:1px solid #24304a; margin:16px 0">

      <h3 style="margin:0 0 10px 0">Participants</h3>
      <table class="table" id="participantsTable">
        <thead>
          <tr>
            <th>Player</th><th>Status</th><th>Team</th><th>Goals</th><th>Assists</th><th>MVP</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="card-h"><strong>Info</strong></div>
    <div class="card-b">
      <p class="muted" style="margin-top:0">{{ match.notes|default:"‚Äî" }}</p>
      {% if match.created_by %}
        <p class="muted">Organizer: {{ match.created_by }}</p>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const MATCH_ID =  "{{match.id}}"";
  const FINALIZED = {{ match.final_score|yesno:"true,false" }};
  const API_BASE = "/api/matches/" + MATCH_ID + "/";

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  async function apiPost(url, body=null){
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: body ? JSON.stringify(body) : null
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || res.statusText);
    }
    return res.status === 204 ? null : await res.json();
  }

  async function loadParticipants(){
    const res = await fetch(API_BASE + "participants/");
    if(!res.ok) return;
    const data = await res.json();

    const tbody = document.querySelector("#participantsTable tbody");
    tbody.innerHTML = "";

    let confirmed = 0;

    data.forEach(p => {
      const status = p.status;
      if(status === "going") confirmed++;

      const playerName = p.player?.nickname || p.player?.user || "‚Äî";
      const teamName = p.team?.name || "‚Äî";
      const mvp = p.is_mvp ? "üèÖ" : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${playerName}</td>
        <td>${status}</td>
        <td>${teamName}</td>
        <td>${p.goals}</td>
        <td>${p.assists}</td>
        <td>${mvp}</td>
      `;
      tbody.appendChild(tr);
    });

    const cap = document.getElementById("cap");
    if(cap) cap.textContent = confirmed;
  }

  async function join(){
    const r = await apiPost(API_BASE + "join/", {status: "going"});
    toast(r.status === "waiting" ? "Match is full, you‚Äôre on waiting list." : "Joined!");
    loadParticipants();
  }

  async function leave(){
    await apiPost(API_BASE + "leave/");
    toast("Left match");
    loadParticipants();
  }

  async function setStatus(){
    const s = document.getElementById("statusSelect").value;
    const r = await apiPost(API_BASE + "join/", {status: s});
    toast("Status updated: " + r.status);
    loadParticipants();
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadParticipants();

    if(FINALIZED) return;

    const btnJoin = document.getElementById("btnJoin");
    const btnLeave = document.getElementById("btnLeave");
    const btnSetStatus = document.getElementById("btnSetStatus");

    if(btnJoin) btnJoin.addEventListener("click", () => join().catch(e => toast("Error: " + e.message)));
    if(btnLeave) btnLeave.addEventListener("click", () => leave().catch(e => toast("Error: " + e.message)));
    if(btnSetStatus) btnSetStatus.addEventListener("click", () => setStatus().catch(e => toast("Error: " + e.message)));
  });
</script>
{% endblock %}
